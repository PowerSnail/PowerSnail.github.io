<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta name="author" content="PowerSnail" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <meta name="theme-color" content="#bd1b37" />

    <title>
      Hardware Accelerated Jellyfin, Docker Composed, in openSUSE · SnailShell
    </title>

    <meta
      property="og:title"
      content="Hardware Accelerated Jellyfin, Docker Composed, in openSUSE"
    />
    <meta property="og:site_name" content="SnailShell" />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://powersnail.com/2023/jellyfin-nvidia-docker/"
    />

    <meta
      property="og:image"
      content="https://powersnail.com/icons/snail.svg"
    />

    <meta
      name="description"
      content="Get Hardware-accelerated encoding and decoding working with NVIDIA in Jellyfin running inside a Docker container in openSUSE"
    />
    <meta
      property="og:description"
      content="Get Hardware-accelerated encoding and decoding working with NVIDIA in Jellyfin running inside a Docker container in openSUSE"
    />

    <link
      rel="canonical"
      href="https://powersnail.com/2023/jellyfin-nvidia-docker/"
    />

    <link id="main-css" rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <div
      style="
        height: 50px;
        width: 100%;
        grid-column: 1/-1;
        grid-template-columns: subgrid;
        background-color: #f57029ff;
        display: grid;
      "
    >
      <div style="grid-column: 3/-3; position: relative">
        <img
          src="/images/halloween.webp"
          width="256px"
          height="48px"
          style="
            position: absolute;
            left: 0;
            top: 0;
            max-width: 100%;
            height: auto;
          "
        />
      </div>
    </div>

    <header>
      <article>
        <nav class="site-nav">
          <a href="/" class="site-title">
            <span class="site-title-text">Snail's Shell</span>
          </a>
          <div class="site-title-fill"></div>
          <a href="/posts/" class="nav-link"> Posts </a>
          <details>
            <summary>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                class="icon"
                width="16"
                height="16"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 4.5v15m7.5-7.5h-15"
                ></path>
              </svg>

              More
            </summary>
            <div class="site-title-more">
              <a href="/index.xml" class="nav-link"> RSS </a>
              <a href="/about/" class="nav-link"> About </a>
              <a href="/sheet-music/" class="nav-link"> Sheet Music </a>
              <a href="/stats/" class="nav-link"> Blog Stats </a>
              <a href="/cat_dot/" class="nav-link"> Moving Red Dot for Cat </a>
              <a href="/game_of_life/" class="nav-link"> Game of Life </a>
            </div>
          </details>
        </nav>
      </article>
    </header>

    <main>
      <article id="post-main">
        <h1>Hardware Accelerated Jellyfin, Docker Composed, in openSUSE</h1>

        <div id="title-subtitle">
          Get Hardware-accelerated encoding and decoding working with NVIDIA in
          Jellyfin running inside a Docker container in openSUSE
        </div>

        <div class="metadata">
          <time datetime="2023-03-12T00:00:00Z">12 Mar 2023</time>
          · 1251 words · 6 minutes read
        </div>
        <hr />

        <h2 id="what-is-it-all-about">
          What is it all about?
          <a href="#what-is-it-all-about"><small>##</small></a>
        </h2>
        <p>
          Here is what I’m trying to do: I want to watch TV at home. On my hard
          drive, is a collection of videos, and I’d like to stream them from my
          PC to mobile devices. The PC runs openSUSE, has an NVIDIA card, and
          Jellyfin—a sort of self-hosted Netflix—is my choice for managing the
          multimedia files and the streaming.
        </p>
        <h2 id="why-am-i-running-jellyfin-in-docker">
          Why am I Running Jellyfin in Docker
          <a href="#why-am-i-running-jellyfin-in-docker"><small>##</small></a>
        </h2>
        <p>
          You can run Jellyfin just by itself, un-containerized, and tell it to
          use the dependencies that are installed by your OS’s package manager.
          It would be more space-efficient. You would need one less moving parts
          (Docker).
        </p>
        <p>
          I run Jellyfin in a Docker container, mainly for the bundled FFmpeg.
          Jellyfin uses FFmpeg as the underlying tool that does all the
          heavy-lifting with regard to processing the videos. The problem is
          that FFmpeg is one of those programs which come with a huge number of
          compiling options, some of which are turned off by default, some can’t
          be enabled in certain distributions due to licensing issues. These
          can’t be tweaked at runtime. I can compile FFmpeg myself, but first,
          that defeats the purpose of saving space, and it would be a pain to
          keep it up to date and resolve compatibility issues between it, the
          OS, and Jellyfin. Using the official docker image will likely be less
          of a headache.
        </p>
        <p>
          Another reason, applicable to software that deals with the file
          system, is that there’s less of a chance that a bug could affect
          unrelated files, since Docker only gives it access to specified
          directories. If Jellyfin messes up, at most my media folder gets
          obliterated, which I have a backup for, and which is easily rectified
          when the rest of the file system is left untouched.
        </p>
        <p>
          At last, it’s easy to put constraints on how many cores Jellyfin can
          use. My machine has 16 cores, and really, to enable the transcoding of
          videos for one or two users, no more than 2 or 3 cores are necessary.
          However, for some reason, when I ran it bare metal, I was never able
          to enact that restriction, whether through Jellyfin’s settings, or
          some other system tools. Docker, on the other hand, can expose a
          selected set of cores, which as far as all the transcoding processes
          know, are all the cores existing.
        </p>
        <h2 id="installing-dependencies">
          Installing Dependencies
          <a href="#installing-dependencies"><small>##</small></a>
        </h2>
        <p>To install Docker and Docker Compose,</p>
        <div class="highlight">
          <pre
            class="chroma"
          ><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo zypper in docker docker-compose
</span></span><span class="line"><span class="cl">sudo systemctl <span class="nb">enable</span> --now docker</span></span></code></pre>
        </div>
        <p>
          To install graphics card drivers (this configuration works only with
          Nvidia’s proprietary drivers), openSUSE has an
          <a href="https://en.opensuse.org/SDB:NVIDIA_drivers">official guide</a
          >, and I use what they call “the easy way”, which means adding a
          repository that is co-managed by NVIDIA and openSUSE, and installing
          the driver via <code>zypper</code>.
        </p>
        <div class="highlight">
          <pre
            class="chroma"
          ><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo zypper addrepo --refresh <span class="s2">"https://download.nvidia.com/opensuse/tumbleweed"</span> NVIDIA
</span></span><span class="line"><span class="cl">sudo zypper in nvidia-video-G06 nvidia-gl-G06</span></span></code></pre>
        </div>
        <p>
          <strong>Do read the guide carefully</strong>, though, as the
          instructions differ for different card models. <code>06</code> is what
          works for my card, something else might for yours.
        </p>
        <p>
          With the proper drivers installed, we also need
          <em>NVIDIA’s Container Toolkit</em> to make it work with Docker. The
          slight problem is that NVIDIA doesn’t package this toolkit for
          Tumbleweed, only Leap, so I’m taking some risks here to use a library
          for a not-exactly-compatible distribution. Well, if it works, it
          works.
        </p>
        <p>
          Using the
          <a
            href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#installing-on-suse-15"
            >guide for Leap 15</a
          >:
        </p>
        <div class="highlight">
          <pre
            class="chroma"
          ><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo zypper ar <span class="s2">"https://nvidia.github.io/libnvidia-container/opensuse-leap15.1/libnvidia-container.repo"</span>
</span></span><span class="line"><span class="cl">sudo zypper ref
</span></span><span class="line"><span class="cl">sudo zypper in nvidia-container-toolkit
</span></span><span class="line"><span class="cl">sudo nvidia-ctk runtime configure --runtime<span class="o">=</span>docker</span></span></code></pre>
        </div>
        <p>
          And I restart the PC at this point, just to make sure that all the
          enabled services are running.
        </p>
        <h2 id="composing-docker-for-jellyfin">
          Composing Docker for Jellyfin
          <a href="#composing-docker-for-jellyfin"><small>##</small></a>
        </h2>
        <p>Here’s what the official Jellyfin guide says:</p>
        <div class="highlight">
          <pre
            class="chroma"
          ><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker pull jellyfin/jellyfin:latest
</span></span><span class="line"><span class="cl">mkdir -p /srv/jellyfin/<span class="o">{</span>config,cache<span class="o">}</span>
</span></span><span class="line"><span class="cl">docker run -d -v /srv/jellyfin/config:/config <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -v /srv/jellyfin/cache:/cache <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -v /media:/media <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --net<span class="o">=</span>host <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    jellyfin/jellyfin:latest</span></span></code></pre>
        </div>
        <p>
          From the host OS’s perspective, the configuration files are stored in
          <code>/srv/jellyfin/config</code>, the caches in
          <code>/srv/jellyfin/cache</code>, the media files in a hypothetical
          <code>/media</code> directory. Just use wherever your media is (<code
            >-v /path/to/media:/media</code
          >). Inside Jellyfin’s configuration, all the media files are relative
          to <code>/media</code>.
        </p>
        <p>
          We have more parameters to pass in and to better manage these options,
          a compose file is simpler and cleaner in my opinion than a shell
          script:
        </p>
        <div class="highlight">
          <pre
            class="chroma"
          ><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># docker-compose.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s2">"3.3"</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">jellyfin</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s2">"/srv/jellyfin/config:/config"</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s2">"/srv/jellyfin/cache:/cache"</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s2">"/path/to/media:/media"</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">network_mode</span><span class="p">:</span><span class="w"> </span><span class="l">host</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s2">"jellyfin/jellyfin:latest"</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">cpuset</span><span class="p">:</span><span class="w"> </span><span class="s2">"13-15"</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">NVIDIA_DRIVER_CAPABILITIES=all</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">NVIDIA_VISIBLE_DEVICES=all</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">reservations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">devices</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span>- <span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l">nvidia</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="nt">count</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="nt">capabilities</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">gpu]</span></span></span></code></pre>
        </div>
        <p>
          To put a restriction on the cores used by Jellyfin, the option
          <code>cpuset</code> is used, and I set it to <code>13-15</code> which
          exposes the last three cores, sufficient for my personally use.
        </p>
        <p>
          To enable hardware acceleration, we give the container permission to
          use the cards with environment variables (these are for the NVIDIA
          Container Toolkit). <code>NVIDIA_DRIVER_CAPABILITIES=all</code> grants
          permission to all capabilities.
          <code>NVIDIA_VISIBLE_DEVICES=all</code> grants permission to all
          cards. You can fine-tune which card and what capabilities Jellyfin has
          access to, by following NVIDIA’s
          <a
            href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/user-guide.html"
            >guide</a
          >.
        </p>
        <p>
          The rest of the options is the Docker Compose’s way of giving access
          of the GPU to the container
          <span class="citation" data-cites="dockerincComposeFileDeploy2023"
            >(<a href="#ref-dockerincComposeFileDeploy2023" role="doc-biblioref"
              >Docker Inc 2023</a
            >)</span
          >.
        </p>
        <h2 id="configuring-nvenc-and-nvdec-in-jellyfin">
          Configuring NVENC and NVDEC in Jellyfin
          <a href="#configuring-nvenc-and-nvdec-in-jellyfin"
            ><small>##</small></a
          >
        </h2>
        <p>
          The model of my graphics card is RTX 2080, which can be checked by
          running:
        </p>
        <div class="highlight">
          <pre
            class="chroma"
          ><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nvidia-smi -L  <span class="c1"># GPU 0: NVIDIA GeForce RTX 2080</span></span></span></code></pre>
        </div>
        <p>
          The encoding and decoding capabilities of the card can be checked on
          NVIDIA’s website:
          <a
            href="https://developer.nvidia.com/video-encode-and-decode-gpu-support-matrix-new"
            >https://developer.nvidia.com/video-encode-and-decode-gpu-support-matrix-new</a
          >. For my 2080, I’ve gotten a good list of decode-able codecs (MPEG-1,
          MPEG-2, VC-1, VP8, VP9, H.264, H.265), and H.264 and H.265 for
          encoding, which are more than enough. The only thing missing is AV1
          support, which is at the moment not that widely used, but whose
          popularity is on the rise.
        </p>
        <p>
          In Jellyfin, in the section
          <code>Dashboad&gt;Playback&gt;Transcoding</code>, set “Hardware
          acceleration” to “Nvidia NVENC”, check the boxes for the supported
          codecs listed above, and tick the options “Enable enhanced NVDEC
          decoder”, and “Enable hardware encoding”.
        </p>
        <p>
          It’s important to know which codec to enable, because Jellyfin blindly
          trusts the configuration, and won’t test whether the GPU is actually
          capable of doing a specific transcoding. If an option were to be
          mis-selected, there wouldn’t be a fallback, and the video would fail
          to load.
        </p>
        <h2 id="how-well-does-it-work">
          How well does it work?
          <a href="#how-well-does-it-work"><small>##</small></a>
        </h2>
        <p>
          Here’s the CPU usage—specifically the usage of core 13, 14, and
          15—when playing a H.265 video, <strong>without</strong> hardware
          acceleration:
        </p>
        <figure>
          <img
            src="/2023/jellyfin-nvidia-docker/cpu-usage-no-gpu.webp"
            alt="An image showing that the usages of the three cores are above 80% during transcoding"
            srcset="
              /2023/jellyfin-nvidia-docker/cpu-usage-no-gpu-400w.webp   400w,
              /2023/jellyfin-nvidia-docker/cpu-usage-no-gpu-600w.webp   600w,
              /2023/jellyfin-nvidia-docker/cpu-usage-no-gpu-800w.webp   800w,
              /2023/jellyfin-nvidia-docker/cpu-usage-no-gpu-1000w.webp 1000w,
              /2023/jellyfin-nvidia-docker/cpu-usage-no-gpu-1200w.webp 1200w,
              /2023/jellyfin-nvidia-docker/cpu-usage-no-gpu.webp       1862w
            "
            width="1862"
            height="162"
          />

          <figcaption>CPU usage without hardware acceleration</figcaption>
        </figure>
        <p>
          After enabling hardware acceleration, when playing the same video, the
          core usages drop to below 40%, and you can see from the
          <code>nvtop</code> (a tool which displays GPU usage), that a FFmpeg
          process is utilizing the GPU. Now, obviously this data is just a
          snapshot and is noisy, given all the other processes running on the
          machine. Although I don’t have a clean, isolated, long-lasting series
          of data showing the history of CPU usage, it is my observation that
          the drop is both significant and consistent through time. For one, it
          no longer causes FPS to fluctuate, when a video starts to play while
          I’m in the middle of a game.
        </p>
        <figure>
          <img
            src="/2023/jellyfin-nvidia-docker/cpu-usage-with-gpu.webp"
            alt="An image showing that the three cores are utilized below 40%"
            srcset="
              /2023/jellyfin-nvidia-docker/cpu-usage-with-gpu-400w.webp   400w,
              /2023/jellyfin-nvidia-docker/cpu-usage-with-gpu-600w.webp   600w,
              /2023/jellyfin-nvidia-docker/cpu-usage-with-gpu-800w.webp   800w,
              /2023/jellyfin-nvidia-docker/cpu-usage-with-gpu-1000w.webp 1000w,
              /2023/jellyfin-nvidia-docker/cpu-usage-with-gpu-1200w.webp 1200w,
              /2023/jellyfin-nvidia-docker/cpu-usage-with-gpu.webp       1862w
            "
            width="1862"
            height="162"
            loading="lazy"
          />

          <figcaption>CPU usage with hardware acceleration</figcaption>
        </figure>
        <figure>
          <img
            src="/2023/jellyfin-nvidia-docker/gpu-usage.webp"
            alt="An image showing GPU usage during transcoding, highlighted is a process of FFmpeg utilizing"
            srcset="
              /2023/jellyfin-nvidia-docker/gpu-usage-400w.webp   400w,
              /2023/jellyfin-nvidia-docker/gpu-usage-600w.webp   600w,
              /2023/jellyfin-nvidia-docker/gpu-usage-800w.webp   800w,
              /2023/jellyfin-nvidia-docker/gpu-usage-1000w.webp 1000w,
              /2023/jellyfin-nvidia-docker/gpu-usage-1200w.webp 1200w,
              /2023/jellyfin-nvidia-docker/gpu-usage.webp       1916w
            "
            width="1916"
            height="1218"
            loading="lazy"
          />

          <figcaption>GPU usage during transcoding</figcaption>
        </figure>
        <p>
          And of course, hardware acceleration isn’t just making the GPU busier
          and the CPU idler; another benefit is that, titularly, the video is
          transcoded faster. This isn’t noticeable in the middle of playing a
          video, because Jellyfin would, like any competent streaming software,
          transcode the next chunk when you are still watching the previous one.
        </p>
        <p>
          It shines when <strong>starting</strong> a video, and more
          importantly, when I’m <strong>jumping around</strong> the progress
          bar. What used to be a few seconds of spinning circles, is now only a
          slight punctuation. The improvement on snappiness simply by moving the
          work from CPU to GPU is, frankly speaking, astonishing.
        </p>

        <h2 id="references">
          References
          <a href="#references"><small>##</small></a>
        </h2>

        <div
          id="refs"
          class="references csl-bib-body hanging-indent"
          data-entry-spacing="0"
          role="list"
        >
          <div
            id="ref-dockerincComposeFileDeploy2023"
            class="csl-entry"
            role="listitem"
          >
            Docker Inc. 2023.
            <span>“Compose File Deploy Reference.”</span> Docker Documentation.
            March 10, 2023.
            <a href="https://docs.docker.com/compose/compose-file/deploy/"
              >https://docs.docker.com/compose/compose-file/deploy/</a
            >.
          </div>
        </div>

        <footer>
          <section class="footer-meta">
            <p>
              <svg
                aria-label="tags"
                class="icon"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
                width="16"
                height="16"
              >
                <path
                  fill-rule="evenodd"
                  d="M5.25 2.25a3 3 0 00-3 3v4.318a3 3 0 00.879 2.121l9.58 9.581c.92.92 2.39 1.186 3.548.428a18.849 18.849 0 005.441-5.44c.758-1.16.492-2.629-.428-3.548l-9.58-9.581a3 3 0 00-2.122-.879H5.25zM6.375 7.5a1.125 1.125 0 100-2.25 1.125 1.125 0 000 2.25z"
                  clip-rule="evenodd"
                ></path>
              </svg>
              <a href="/tags/docker"><code>Docker</code></a
              >, <a href="/tags/jellyfin"><code>Jellyfin</code></a
              >, <a href="/tags/opensuse"><code>openSUSE</code></a
              >,
              <a href="/tags/system-administration"
                ><code>system administration</code></a
              >, <a href="/tags/technology"><code>technology</code></a
              >, <a href="/tags/nvidia"><code>NVIDIA</code></a
              >, <a href="/tags/ffmpeg"><code>FFmpeg</code></a>
            </p>
          </section>

          <section>
            <p>
              Leave a comment via email:
              <a
                href="mailto:comment.2023.jellyfin-nvidia-docker@powersnail.com"
                >comment.2023.jellyfin-nvidia-docker@powersnail.com</a
              >.
            </p>
          </section>
        </footer>
      </article>
    </main>
    <footer>
      <article><div>© PowerSnail 2023</div></article>
    </footer>
  </body>
</html>
