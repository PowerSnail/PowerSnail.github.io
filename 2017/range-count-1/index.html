<!doctype html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta name="author" content="PowerSnail" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <meta name="theme-color" content="#bd1b37" />

    <title>Count 1s in Range · SnailShell</title>

    <meta property="og:title" content="Count 1s in Range" />
    <meta property="og:site_name" content="SnailShell" />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://powersnail.com/2017/range-count-1/"
    />

    <meta
      property="og:image"
      content="https://powersnail.com/icons/snail.svg"
    />

    <link rel="canonical" href="https://powersnail.com/2017/range-count-1/" />

    <script
      type="text/javascript"
      id="MathJax-script"
      src="/js/bundle.39b4c9e45c7f60379025444391711d5dc496457cd3480b1edb45bf24649fd217.js"
      defer
    ></script>

    <link id="main-css" rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <header>
      <article>
        <nav class="site-nav">
          <a href="/" class="site-title">
            <span class="site-title-text">Snail's Shell</span>
          </a>
          <div class="site-title-fill"></div>
          <a href="/posts/" class="nav-link"> Posts </a>
          <details>
            <summary>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                class="icon"
                width="16"
                height="16"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 4.5v15m7.5-7.5h-15"
                />
              </svg>

              More
            </summary>
            <div class="site-title-more">
              <a href="/index.xml" class="nav-link"> RSS </a>
              <a href="/about/" class="nav-link"> About </a>
              <a href="/sheet-music/" class="nav-link"> Sheet Music </a>
              <a href="/stats/" class="nav-link"> Blog Stats </a>
              <a href="/cat_dot/" class="nav-link"> Moving Red Dot for Cat </a>
              <a href="/game_of_life/" class="nav-link"> Game of Life </a>
            </div>
          </details>
        </nav>
      </article>
    </header>

    <main>
      <article id="post-main">
        <h1>Count 1s in Range</h1>

        <div class="metadata">
          <time datetime="2017-01-06T00:00:00Z">06 Jan 2017</time>
          · 651 words · 2 minutes read
        </div>
        <hr />

        <p>
          在 codefights 上做到了一个很有意思的题。给你 a, b
          两个数，假设你构建了一个从 a 到 b 的 array，所有这些数的 binary
          representation 里面有多少个 1？
        </p>
        <h1 id="naive-solution">
          Naive Solution
          <a href="#naive-solution"><small>#</small></a>
        </h1>
        <p>
          最简单的办法 (随手翻了两个别人的答案都是这个),
          就是一个数一个数查有多少 1. 笨一点的手工查, 聪明一点的用 built-in
          function 查. 但是无论如何, 复杂度都是 O(b - a).
        </p>
        <h1 id="logn-solution">
          Log(n) Solution
          <a href="#logn-solution"><small>#</small></a>
        </h1>
        <p>
          我们先思考一个简化版本的问题: 所有
          <code>unsigned int (c++)</code> 里面有多少 1? 答案是所有的 bit / 2,
          因为当我们把所有数都写成 2 进制, 一半是 1, 一半是0.
        </p>
        <p>
          我们 generalize 一下: 对于任意的 $m$, 所有 $m$ 位的正整数里有 $(2^m *
          m) / 2$.
        </p>
        <p>
          当我们的上限不是<em>位数</em>，而是一个数字 $b$, 我们可以把 $b$ 分成 3
          各部分。假设 $b$ 不为 0, $b$ 的二进制形式应该是 $1xxxx$&hellip; 假设
          $b$ 有 $m + 1$ 位.
        </p>
        <p>现在以 $100&hellip;0$ 为 <code>line</code>:</p>
        <ol>
          <li><strong>line</strong> 一个 &lsquo;1&rsquo;</li>
          <li>
            <strong>below line</strong>: 所有 $m$ 位数有$ (2^m * m) / 2$ 个
            &lsquo;1&rsquo;. 这个数从前面的结论得来.
          </li>
          <li>
            <strong>above line</strong>: 除去最左边的 $1$， 右边的部分又变成从
            $0$ 开始查. 我们可以用一个简单地递归来解决这个部分。
          </li>
        </ol>
        <p>pseudo code:</p>
        <div class="highlight">
          <pre
            class="chroma"
          ><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="n">function</span> <span class="n">allBits</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="sr">//</span> <span class="err">不考虑负数</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="n">b</span><span class="p">;</span> <span class="sr">//</span> <span class="ss">basecase</span><span class="p">:</span> <span class="err">只有一位</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">=</span> <span class="n">num_of_bits</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">line</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">onesBelowLine</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">onesAboveLine</span> <span class="o">=</span> <span class="n">allBits</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">line</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">onesBelowLine</span> <span class="o">+</span> <span class="n">onesAboveLine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre>
        </div>
        <p>下面回到原始问题，给定底线和上限，a, b， 我们可以简单地转换一下：</p>
        <div class="highlight">
          <pre
            class="chroma"
          ><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="n">function</span> <span class="n">rangeBitCount</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">allBits</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="n">allBits</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre>
        </div>
        <h1 id="复杂度证明">
          复杂度证明
          <a href="#%e5%a4%8d%e6%9d%82%e5%ba%a6%e8%af%81%e6%98%8e"
            ><small>#</small></a
          >
        </h1>
        <p>
          这个算法的复杂度很简单，因为这个 recursion 可以很容易的转换成 tail
          recursion，再变成复杂度相同的 iteration. 这个 iteration
          每次去掉最高位的 1，因此最多有 $\log(b)$ 次循环；每次循环做了 constant
          的基本算数，因此最后的复杂度应该是 $\log(b)$。
        </p>
        <h1 id="c-source-code">
          C++ Source Code
          <a href="#c-source-code"><small>#</small></a>
        </h1>
        <div class="highlight">
          <pre
            class="chroma"
          ><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">allBits</span><span class="p">(</span><span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">num_bit</span> <span class="o">=</span> <span class="mi">31</span> <span class="o">-</span> <span class="n">__builtin_clz</span><span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">num_bit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">count_below</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_bit</span> <span class="o">*</span> <span class="n">line</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">above</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">line</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">count_above</span> <span class="o">=</span> <span class="n">above</span> <span class="o">+</span> <span class="n">allBits</span><span class="p">(</span><span class="n">above</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">count_above</span> <span class="o">+</span> <span class="n">count_below</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">rangeBitCount</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">allBits</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="n">allBits</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre>
        </div>

        <footer>
          <section class="footer-meta">
            <p>
              <svg
                aria-label="tags"
                class="icon"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
                width="16"
                height="16"
              >
                <path
                  fill-rule="evenodd"
                  d="M5.25 2.25a3 3 0 00-3 3v4.318a3 3 0 00.879 2.121l9.58 9.581c.92.92 2.39 1.186 3.548.428a18.849 18.849 0 005.441-5.44c.758-1.16.492-2.629-.428-3.548l-9.58-9.581a3 3 0 00-2.122-.879H5.25zM6.375 7.5a1.125 1.125 0 100-2.25 1.125 1.125 0 000 2.25z"
                  clip-rule="evenodd"
                />
              </svg>
              <a href="/tags/computer-science"><code>computer science</code></a
              >, <a href="/tags/algorithm"><code>algorithm</code></a
              >, <a href="/tags/codefights"><code>codefights</code></a
              >, <a href="/tags/c&#43;&#43;"><code>C&#43;&#43;</code></a>
            </p>
          </section>

          <section>
            <p>
              Leave a comment via email:
              <a href="mailto:comment.2017.range-count-1@powersnail.com"
                >comment.2017.range-count-1@powersnail.com</a
              >.
            </p>
          </section>
        </footer>
      </article>
    </main>
    <footer>
      <article><div>© PowerSnail 2017</div></article>
    </footer>
  </body>
</html>
