<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="generator" content="HTML Tidy for HTML5 for Linux version 5.8.0">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' https://snailshell.goatcounter.com/count https://mirrors.creativecommons.org/; style-src 'self' 'unsafe-inline'">
    <meta name="author" content="PowerSnail">
    <meta name="description" content="To use Grub2 theme preview on openSUSE, two environment variables needs to be overridden.">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#af3000">
    <meta name="msapplication-TileColor" content="#000000">
    <meta name="theme-color" content="#af3000">
    <title>
      Fixing Grub2 Theme Preview on Opensuse Tumbleweed · SnailShell
    </title>
    <link rel="prefetch" href="/images/front-cover.webp" as="image" crossorigin="">
    <link rel="stylesheet" href="/style.css">
    <link rel="canonical" href="https://powersnail.com/2022/grub2-theme-preview-opensuse/">
  </head>
  <body>
    <header>
      <a href="https://powersnail.com/" id="site-title">SnailShell</a>
      <nav>
        <a type="button" href="/posts/">Posts</a> <a type="button" href="/status/">Status</a> <a type="button" href="/about/">About</a>
      </nav>
    </header><img class="goatcounter" alt="" width="1" height="1" src="https://snailshell.goatcounter.com/count?p=%2f2022%2fgrub2-theme-preview-opensuse%2f&amp;t=Fixing%20Grub2%20Theme%20Preview%20on%20Opensuse%20Tumbleweed">
    <main>
      <article>
        <header>
          <h1>
            Fixing Grub2 Theme Preview on Opensuse Tumbleweed
          </h1>
          <hr>
          <div id="metadata">
            <span class="icon-prefix calendar-event">2022-08-06</span> <span class="icon-prefix calculator">345 words</span> <span class="icon-prefix clock">2 minutes read</span> <span class="icon-prefix tags"><a class="tag" href="/tags/computer-science">computer science</a></span>
          </div>
        </header>
        <p>
          <strong>TLDR</strong>: To use <a href="https://github.com/hartwork/grub2-theme-preview">grub2-theme-preview</a> on openSUSE, you need to override the paths of firmware and ovmf:
        </p>
        <div class="highlight">
          <pre class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">G2TP_GRUB_LIB</span><span class="o">=</span>/usr/share/grub2
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">G2TP_OVMF_IMAGE</span><span class="o">=</span>/usr/share/qemu/ovmf-x86_64-code.bin</span></span></code></pre>
        </div>
        <hr>
        <p>
          Running after installing grub2-theme-preview and it’s dependencies on openSUSE Tumbleweed, I was given the following error:
        </p>
        <div class="highlight">
          <pre class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt; grub2-theme-preview .
</span></span><span class="line"><span class="cl">ERROR: <span class="o">[</span>Errno 2<span class="o">]</span> GRUB platform directory <span class="s2">"/usr/lib/grub/x86_64-efi"</span> not found</span></span></code></pre>
        </div>
        <p>
          This is because grub2-theme-preview hard codes a few paths for this file, which unfortunately do not include openSUSE’s layout.
        </p>
        <p>
          The path can be overridden with undocumented an environment variables, which isn’t mentioned in the help message or REAME.md, but it can be seen in code:
        </p>
        <div class="highlight">
          <pre class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># __main__.py</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_grub2_directory</span><span class="p">(</span><span class="n">platform</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s1">'</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'G2TP_GRUB_LIB'</span><span class="p">,</span> <span class="s1">'/usr/lib/grub'</span><span class="p">),</span> <span class="n">platform</span><span class="p">)</span></span></span></code></pre>
        </div>
        <p>
          Where is it in openSUSE? The error message says that “/usr/lib/grub/x86_64-efi” was not found, so let’s find x86-64-efi:
        </p>
        <div class="highlight">
          <pre class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt;  fd x86_64-efi /usr
</span></span><span class="line"><span class="cl">/usr/share/grub2/x86_64-efi/</span></span></code></pre>
        </div>
        <p>
          The code tells us that <code>G2TP_GRUB_LIB</code> should refer to the directory that contains <code>x86_64-efi</code>, so we can override the environment variable:
        </p>
        <div class="highlight">
          <pre class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">G2TP_GRUB_LIB</span><span class="o">=</span>/usr/share/grub2</span></span></code></pre>
        </div>
        <p>
          Now, let’s run it again:
        </p>
        <div class="highlight">
          <pre class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt; grub2-theme-preview .
</span></span><span class="line"><span class="cl">ERROR: <span class="o">[</span>Errno 2<span class="o">]</span> OVMF image file <span class="s2">"/usr/share/[..]/OVMF_CODE.fd"</span> is missing, please install package <span class="s1">'edk2-ovmf'</span> or <span class="s1">'ovmf'</span>.</span></span></code></pre>
        </div>
        <p>
          Okay, so there’s another one. Again, digging into the code, we can find another environment variable:
        </p>
        <div class="highlight">
          <pre class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_grub2_ovmf_tuple</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">omvf_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'G2TP_OVMF_IMAGE'</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">omvf_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Support non-standard locations e.g. NixOS</span>
</span></span><span class="line"><span class="cl">        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">omvf_image</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">'/usr/share/edk2-ovmf/OVMF_CODE.fd'</span><span class="p">,</span>  <span class="c1"># Gentoo and its derivatives</span>
</span></span><span class="line"><span class="cl">            <span class="s1">'/usr/share/edk2-ovmf/x64/OVMF_CODE.fd'</span><span class="p">,</span>  <span class="c1"># Arch Linux and its derivatives</span>
</span></span><span class="line"><span class="cl">            <span class="s1">'/usr/share/OVMF/OVMF_CODE.fd'</span><span class="p">,</span>  <span class="c1"># Debian and its derivatives</span>
</span></span><span class="line"><span class="cl">            <span class="s1">'/usr/share/edk2/ovmf/OVMF_CODE.fd'</span><span class="p">,</span>  <span class="c1"># Fedora (and its derivatives?)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span></span></span></code></pre>
        </div>
        <p>
          <code>OVMF_CODE.fd</code>, however, is more elusive. <code>fd OVMF_CODE</code> returns nothing. After some Googling and forum digging, it turns out that openSUSE does not name the UEFI firmware as <code>OVMF_CODE.fd</code>; rather, <code>ovmf-[arch]-code.bin</code>. For my purpose, the x86_64 version is located at <code>/usr/share/qemu/ovmf-x86_64-code.bin</code>. This time, <code>grub2-theme-preview</code> is looking for the path of the file, rather than the directory, so, we set the environment variable:
        </p>
        <div class="highlight">
          <pre class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">G2TP_OVMF_IMAGE</span><span class="o">=</span>/usr/share/qemu/ovmf-x86_64-code.bin</span></span></code></pre>
        </div>
        <p>
          Running <code>grub2-theme-preview</code> once again:
        </p>
        <div class="highlight">
          <pre class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt; grub2-theme-preview .
</span></span><span class="line"><span class="cl">INFO: Appending to fonts to load: ascii.pf2
</span></span><span class="line"><span class="cl">INFO: Appending to fonts to load: DejaVuSans-Bold14.pf2
</span></span><span class="line"><span class="cl">INFO: Appending to fonts to load: DejaVuSans10.pf2
</span></span><span class="line"><span class="cl">INFO: Appending to fonts to load: DejaVuSans12.pf2
</span></span><span class="line"><span class="cl">INFO: Found OVMF image at <span class="s1">'/usr/share/qemu/ovmf-x86_64-code.bin'</span>.
</span></span><span class="line"><span class="cl">INFO: Please give GRUB a moment to show up in QEMU...</span></span></code></pre>
        </div>
        <p>
          <em>Voila!</em>
        </p>
        <p>
          <img src="/images/opensuse-grub-preview.webp" alt="Screenshot of grub2-theme-preview" srcset="/images/opensuse-grub-preview-480w.webp 480w,/images/opensuse-grub-preview-800w.webp 800w,/images/opensuse-grub-preview.webp 1200w" width="1200" height="675">
        </p>
        <footer>
          <p id="cc">
            This work is licensed under <a href="http://creativecommons.org/licenses/by-sa/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">CC BY-SA 4.0 <img alt="Creative Commons License CC BY-SA 4.0" src="/images/cc-all.svg" style="height:1.4em; width: auto;" loading="lazy" width="30" height="11"></a>
          </p>
        </footer>
      </article>
    </main>
    <footer>
      <nav>
        <a class="icon-prefix rss" href="/index.xml">RSS</a> <a class="icon-prefix brand-github" href="https://github.com/PowerSnail/">Github</a> <a class="icon-prefix mail" href="mailto:hj@powersnail.com">hj@powersnail.com</a>
      </nav>
      <div>
        © PowerSnail 2022
      </div>
    </footer>
  </body>
</html>
